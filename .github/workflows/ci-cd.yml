name: CI/CD Deploy to Aliyun

# 自动部署流程：推送代码 → 构建镜像 → 推送到阿里云 ACR → 服务器拉取运行

on:
  push:
    branches: [master, main]
  workflow_dispatch:

concurrency:
  group: cool-box-deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_ACR_REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      - name: Generate image tags
        id: tags
        run: |
          BUILD_TIME=$(date +'%Y%m%d-%H%M')
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ALIYUN_ACR_REGISTRY }}/${{ secrets.ALIYUN_ACR_REPO }}:latest
            ${{ secrets.ALIYUN_ACR_REGISTRY }}/${{ secrets.ALIYUN_ACR_REPO }}:${{ steps.tags.outputs.build_time }}
            ${{ secrets.ALIYUN_ACR_REGISTRY }}/${{ secrets.ALIYUN_ACR_REPO }}:sha-${{ steps.tags.outputs.short_sha }}

  deploy-to-server:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Aliyun Server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SERVER_SSH_HOST }}
          SSH_PORT: ${{ secrets.ALIYUN_SERVER_PORT }}
          SSH_USER: ${{ secrets.ALIYUN_SERVER_SSH_USER }}
          SSH_KEY: ${{ secrets.ALIYUN_SERVER_SSH_KEY }}
          ACR_REGISTRY: ${{ secrets.ALIYUN_ACR_REGISTRY }}
          ACR_REPO: ${{ secrets.ALIYUN_ACR_REPO }}
          ACR_USERNAME: ${{ secrets.ALIYUN_ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ALIYUN_ACR_PASSWORD }}
        run: |
          set -euo pipefail

          printf '%s' "$SSH_KEY" | base64 -d > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          
          sed -i 's/\r$//' /tmp/deploy_key
          
          ssh-keygen -lf /tmp/deploy_key >/dev/null

          ssh \
            -o BatchMode=yes \
            -o GSSAPIAuthentication=no \
            -o PreferredAuthentications=publickey \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o PubkeyAcceptedAlgorithms=+ssh-rsa \
            -i /tmp/deploy_key \
            -p "$SSH_PORT" \
            "$SSH_USER@$SSH_HOST" \
            "echo 'SSH connected successfully'" >/dev/null

          ssh \
            -o BatchMode=yes \
            -o GSSAPIAuthentication=no \
            -o PreferredAuthentications=publickey \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o PubkeyAcceptedAlgorithms=+ssh-rsa \
            -i /tmp/deploy_key \
            -p "$SSH_PORT" \
            "$SSH_USER@$SSH_HOST" \
            "ACR_REGISTRY='$ACR_REGISTRY' ACR_REPO='$ACR_REPO' ACR_USERNAME='$ACR_USERNAME' ACR_PASSWORD='$ACR_PASSWORD' bash -s" << 'EOF'
            set -euo pipefail

            printf '%s' "$ACR_PASSWORD" | docker login --username "$ACR_USERNAME" --password-stdin "$ACR_REGISTRY"
            docker pull "$ACR_REGISTRY/$ACR_REPO:latest"
            docker stop cool-box || true
            docker rm cool-box || true
            docker run -d \
              --name cool-box \
              -p 3000:80 \
              --restart unless-stopped \
              "$ACR_REGISTRY/$ACR_REPO:latest"
            docker ps
          EOF
